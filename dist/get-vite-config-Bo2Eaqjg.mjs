import { makeLegalIdentifier } from '@rollup/pluginutils';
import { resolveConfig } from 'vite';

const dtsTemplate = (code) => `/* eslint-disable */
/* prettier-ignore */
// @ts-nocheck
/**
 * Generated by vite-css-modules
 * https://npmjs.com/vite-css-modules
 */
${code ? `
${code}
` : ""}`;
const genereateNamedExports = (exportedVariables, exportMode, allowArbitraryNamedExports) => {
  const prepareNamedExports = exportedVariables.map(
    ([jsVariable, exportName]) => {
      if (exportMode === "both" && exportName === '"default"') {
        return;
      }
      if (jsVariable === exportName) {
        return `	${jsVariable}`;
      }
      if (exportName[0] !== '"' || allowArbitraryNamedExports) {
        return `	${jsVariable} as ${exportName}`;
      }
      return "";
    }
  ).filter(Boolean);
  if (prepareNamedExports.length === 0) {
    return "";
  }
  return `export {
${prepareNamedExports.join(",\n")}
};`;
};
const generateDefaultExport = (exportedVariables) => {
  const properties = exportedVariables.map(
    ([jsVariable, exportName]) => {
      const key = jsVariable === exportName ? jsVariable : exportName;
      return `	${key}: typeof ${jsVariable};`;
    }
  ).join("\n");
  return `declare const __default_export__: {
${properties}
};
export default __default_export__;`;
};
const generateTypes = (exports, exportMode, allowArbitraryNamedExports = false) => {
  const variables = /* @__PURE__ */ new Set();
  const exportedVariables = Object.entries(exports).flatMap(
    ([exportName, { exportAs }]) => {
      const jsVariable = makeLegalIdentifier(exportName);
      variables.add(`declare const ${jsVariable}: string;`);
      return Array.from(exportAs).map((exportAsName) => {
        const exportNameSafe = makeLegalIdentifier(exportAsName);
        if (exportAsName !== exportNameSafe) {
          exportAsName = JSON.stringify(exportAsName);
        }
        return [jsVariable, exportAsName];
      });
    }
  );
  if (exportedVariables.length === 0) {
    return dtsTemplate();
  }
  return dtsTemplate([
    Array.from(variables).join("\n"),
    exportMode === "both" || exportMode === "named" ? genereateNamedExports(exportedVariables, exportMode, allowArbitraryNamedExports) : "",
    exportMode === "both" || exportMode === "default" ? generateDefaultExport(exportedVariables) : ""
  ].filter(Boolean).join("\n\n"));
};

const arbitraryModuleNamespaceNames = {
  // https://github.com/evanw/esbuild/blob/c809af050a74f022d9cf61c66e13365434542420/compat-table/src/index.ts#L392
  es: [2022],
  chrome: [90],
  node: [16],
  firefox: [87],
  safari: [14, 1],
  ios: [14, 5]
};
const targetPattern = /^(chrome|deno|edge|firefox|hermes|ie|ios|node|opera|rhino|safari|es)(\w+)/i;
const parseTarget = (target) => {
  const hasType = target.match(targetPattern);
  if (!hasType) {
    return;
  }
  const [, type, version] = hasType;
  return [
    type.toLowerCase(),
    version.split(".").map(Number)
  ];
};
const compareSemver = (semverA, semverB) => semverA[0] - semverB[0] || (semverA[1] || 0) - (semverB[1] || 0) || (semverA[2] || 0) - (semverB[2] || 0) || 0;
const supportsArbitraryModuleNamespace = ({ build: { target: targets } }) => Boolean(
  targets && (Array.isArray(targets) ? targets : [targets]).every((target) => {
    if (target === "esnext") {
      return true;
    }
    const hasType = parseTarget(target);
    if (!hasType) {
      return false;
    }
    const [type, version] = hasType;
    const addedInVersion = arbitraryModuleNamespaceNames[type];
    if (!addedInVersion) {
      return false;
    }
    return compareSemver(addedInVersion, version) <= 0;
  })
);

const ENV_VAR = "VITE_CSS_MODULES_CAPTURE";
const isConfigCaptureEnabled = () => process.env[ENV_VAR] === "1";
const captureConfig = (config) => {
  process.env[`${ENV_VAR}_DATA`] = JSON.stringify(config);
};
const getViteConfig = async () => {
  process.env[ENV_VAR] = "1";
  const viteConfig = await resolveConfig(
    {
      root: process.cwd(),
      // Uses `import()` and avoids esbuild bundling in Vite 6/7 (ignored in Vite 5)
      configLoader: "native"
    },
    "build",
    "production",
    "production"
  );
  console.log(viteConfig);
  const data = process.env[`${ENV_VAR}_DATA`];
  if (!data) {
    throw new Error(
      "Failed to capture vite-css-modules config. Ensure the plugin is configured in your Vite config"
    );
  }
  const pluginOptions = JSON.parse(data);
  return {
    viteConfig,
    pluginOptions
  };
};

export { getViteConfig as a, captureConfig as c, generateTypes as g, isConfigCaptureEnabled as i, supportsArbitraryModuleNamespace as s };
